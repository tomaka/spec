<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>WebAssembly runtime</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="state.html"><strong aria-hidden="true">1.</strong> State</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="runtime.html" class="active"><strong aria-hidden="true">1.1.</strong> WebAssembly runtime</a></li></ol></li><li class="chapter-item expanded "><a href="blocks.html"><strong aria-hidden="true">2.</strong> Blocks</a></li><li class="chapter-item expanded "><a href="network.html"><strong aria-hidden="true">3.</strong> Networking</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="network-transport.html"><strong aria-hidden="true">3.1.</strong> Transport</a></li><li class="chapter-item expanded "><a href="network-protocol.html"><strong aria-hidden="true">3.2.</strong> Protocols</a></li></ol></li><li class="chapter-item expanded "><a href="liveness-requirements.html"><strong aria-hidden="true">4.</strong> Liveness requirements</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="webassembly-runtime"><a class="header" href="#webassembly-runtime">WebAssembly runtime</a></h1>
<h2 id="runtime-code"><a class="header" href="#runtime-code">Runtime code</a></h2>
<p>The <strong>runtime code</strong> is defined as either:</p>
<ul>
<li>The <strong>runtime WebAssembly</strong> (defined below).</li>
<li>The bytes <code>0x52BC537646DB8E05</code>, followed with the <a href="https://datatracker.ietf.org/doc/html/rfc8878">zstd</a>-encoded <strong>runtime WebAssembly</strong>. The decoded <strong>runtime WebAssembly</strong> must not be larger than 52428800 bytes (i.e. 50 MiB).</li>
</ul>
<p>The <em>runtime WebAssembly</em> always starts with the bytes <code>0x0061736D</code>, making it possible to unambiguously differentiate the two situations.</p>
<blockquote>
<p><strong>Note</strong>: Implementers should be aware of the danger of so-called &quot;zip bombs&quot; where a zstd-encoded payload decodes to a huge output. Implementers should make sure to cap the size of the output while decoding is in progress.</p>
</blockquote>
<h2 id="runtime-webassembly"><a class="header" href="#runtime-webassembly">Runtime WebAssembly</a></h2>
<p>The <strong>runtime WebAssembly</strong> is defined as a <a href="https://webassembly.github.io/spec/">WebAssembly</a> program in binary format, with the following additional constraints:</p>
<ul>
<li>The WebAssembly binary must not use any of the WebAssembly extensions that was used after the launch of WebAssembly 1.0.</li>
<li>It must not have any <a href="https://webassembly.github.io/spec/core/bikeshed/#start-function%E2%91%A0"><em>start function</em>, as defined by the WebAssembly specification</a>.</li>
<li>It must either export exactly one memory named <code>memory</code> (with module name <code>env</code>), or import exactly one memory.</li>
<li>It must export a global named <code>__heap_base</code> (with module name <code>env</code>) of type <code>i32</code>.</li>
<li>TODO: runtime spec</li>
</ul>
<p>The <strong>runtime WebAssembly</strong> is allowed to import any function, whatever their signature. A host implementation must not consider a <strong>runtime WebAssembly</strong> as invalid only because it imports an unknown function or a known function with a signature that doesn't match the expected one. A host implementation must raise an error only if such a function is called during the execution of the WebAssembly.</p>
<h2 id="runtime-call"><a class="header" href="#runtime-call">Runtime call</a></h2>
<p>Given a <em>runtime WebAssembly</em>, a <em>number of heap pages</em>, a <a href="state.html"><em>state</em></a>, a <em>runtime entry point</em>, an <em>offchain functions enabled</em> boolean, and some input data, the host can <strong>do a runtime call</strong>.</p>
<p>Doing a runtime call consists in the following step:</p>
<ul>
<li>Verify that the <em>runtime entry point</em> is a function exported by the <em>runtime WebAssembly</em>, and whose signature is <code>(func $runtime_entry_point (param $data i32) (param $len i32) (result i64))</code>.</li>
<li>Instantiate the <em>runtime WebAssembly</em>, as defined <a href="https://webassembly.github.io/spec/core/bikeshed/#instantiation%E2%91%A1">here</a>. The list of imports is described below.</li>
<li>Initialize the <em>overlay</em>, defined as the list of modifications performed to the state since the beginning of the execution.</li>
<li>Read the value of the <code>__heap_base</code> global exported by the <em>runtime WebAssembly</em>, and initialize a new <em>allocator</em>.</li>
<li>Use the allocator in order to allocate a buffer of size equal to the input data. Copy the input data to this buffer.</li>
<li>Invoke the <em>runtime entry point</em>, as defined <a href="https://webassembly.github.io/spec/core/bikeshed/#invocation%E2%91%A1">here</a>, passing as argument a pointer to the buffer containing the input data and the length of the input data.</li>
<li>Once the invocation is finished, TODO describe how to get output.</li>
</ul>
<p>TODO: talk about memory consumption and halting problem stuff</p>
<p>The following functions can be imported by the <strong>runtime WebAssembly</strong>:</p>
<h3 id="ext_allocator_malloc_version_1"><a class="header" href="#ext_allocator_malloc_version_1">ext_allocator_malloc_version_1</a></h3>
<pre><code>(func $ext_allocator_malloc_version_1
    (param $size i32) (result i32))
</code></pre>
<h3 id="ext_allocator_free_version_1"><a class="header" href="#ext_allocator_free_version_1">ext_allocator_free_version_1</a></h3>
<pre><code>(func $ext_allocator_free_version_1 (param $ptr i32))
</code></pre>
<h3 id="ext_storage_set_version_1"><a class="header" href="#ext_storage_set_version_1">ext_storage_set_version_1</a></h3>
<pre><code>(func $ext_storage_set_version_1
    (param $key i64) (param $value i64))
</code></pre>
<p>With:</p>
<ul>
<li><code>key</code>: A pointer-size to the memory location containing the key.</li>
<li><code>value</code>: A pointer-size to the memory location containing the value.</li>
</ul>
<p>The implementation must set the given <em>key</em> to the given <em>value</em> in the <em>overlay</em>.</p>
<h3 id="ext_storage_get_version_1"><a class="header" href="#ext_storage_get_version_1">ext_storage_get_version_1</a></h3>
<pre><code>(func $ext_storage_get_version_1
    (param $key i64) (result i64))
</code></pre>
<p>With:</p>
<ul>
<li><code>key</code>: A pointer-size to the memory location containing the key.</li>
<li>The result: a pointer-size.</li>
</ul>
<p>If the given <em>key</em> is present in the overlay, TODO</p>
<h3 id="ext_storage_clear_version_1"><a class="header" href="#ext_storage_clear_version_1">ext_storage_clear_version_1</a></h3>
<pre><code>(func $ext_storage_clear_version_1
    (param $key i64))
</code></pre>
<p>With:</p>
<ul>
<li><code>key</code>: A pointer-size to the memory location containing the key.</li>
</ul>
<p>The implementation must set the given <em>key</em> in the <em>overlay</em> to being non-existent.</p>
<h3 id="ext_storage_root_version_1"><a class="header" href="#ext_storage_root_version_1">ext_storage_root_version_1</a></h3>
<pre><code>(func $ext_storage_root_version_1
    (return i64))
</code></pre>
<p>With:</p>
<ul>
<li>The result: a pointer-size.</li>
</ul>
<p>The implementation must build a temporary <em>state</em> by applying the <em>overlay</em> to the state provided as input, then calculate the <em>Merkle value</em> of this temporary state.
The implementation then allocates a 32 bytes buffer using the same mechanism as <code>ext_allocator_malloc_version_1</code>, write the calculated Merkle value in it, and return a pointer-size to it.</p>
<blockquote>
<p><strong>Note</strong>: Runtimes are encouraged to not perform any further modification to the storage after having called this function. An implementation can use this hint in order to cache the result of its calculation for later.</p>
</blockquote>
<h3 id="ext_storage_root_version_2"><a class="header" href="#ext_storage_root_version_2">ext_storage_root_version_2</a></h3>
<pre><code>(func $ext_storage_root_version_2
    (param $version i32) (return i64))
</code></pre>
<p>This function is deprecated and shouldn't be used by runtimes.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="state.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="blocks.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="state.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="blocks.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
