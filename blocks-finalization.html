<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Blocks finalization</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="state.html"><strong aria-hidden="true">1.</strong> State</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="runtime.html"><strong aria-hidden="true">1.1.</strong> WebAssembly runtime</a></li></ol></li><li class="chapter-item expanded "><a href="blocks.html"><strong aria-hidden="true">2.</strong> Blocks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="blocks-verification.html"><strong aria-hidden="true">2.1.</strong> Blocks verification</a></li><li class="chapter-item expanded "><a href="blocks-authoring.html"><strong aria-hidden="true">2.2.</strong> Blocks authoring</a></li><li class="chapter-item expanded "><a href="blocks-finalization.html" class="active"><strong aria-hidden="true">2.3.</strong> Blocks finalization</a></li></ol></li><li class="chapter-item expanded "><a href="transactions.html"><strong aria-hidden="true">3.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="parachains.html"><strong aria-hidden="true">4.</strong> Parachains</a></li><li class="chapter-item expanded "><a href="network.html"><strong aria-hidden="true">5.</strong> Networking</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="network-transport.html"><strong aria-hidden="true">5.1.</strong> Transport</a></li><li class="chapter-item expanded "><a href="network-matrix.html"><strong aria-hidden="true">5.2.</strong> Validators matrix</a></li><li class="chapter-item expanded "><a href="network-protocol.html"><strong aria-hidden="true">5.3.</strong> Protocols</a></li><li class="chapter-item expanded "><a href="network-kad.html"><strong aria-hidden="true">5.4.</strong> Kademlia</a></li></ol></li><li class="chapter-item expanded "><a href="requirements.html"><strong aria-hidden="true">6.</strong> Requirements</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="blocks-finalization"><a class="header" href="#blocks-finalization">Blocks finalization</a></h1>
<h2 id="grandpa-validators-set"><a class="header" href="#grandpa-validators-set">Grandpa validators set</a></h2>
<p>Given a <em>block header</em>, the <strong>Grandpa validators set</strong> can be determined through the following process:</p>
<p>TODO finish</p>
<ul>
<li>Find the first ancestor that has a Grandpa digest item.</li>
</ul>
<p>TODO make it clear that for forced changes the block must have been executed, otherwise security issue</p>
<blockquote>
<p><strong>Note</strong>: The <em>Grandpa validators set</em> of a block corresponds to the list of validators that can finalize blocks that are children of the block in question. The block itself must be finalized by validators of the validators set of the parent block.</p>
</blockquote>
<p>The <strong>validators set id</strong> of a block can be determined through:</p>
<p>TODO</p>
<h2 id="grandpa-commits-and-justifications"><a class="header" href="#grandpa-commits-and-justifications">Grandpa commits and justifications</a></h2>
<h3 id="grandpa-commit"><a class="header" href="#grandpa-commit">Grandpa commit</a></h3>
<p>A <strong>Grandpa commit</strong> is defined as:</p>
<table><thead><tr><th>Field name</th><th>Type</th><th>Size (bytes)</th></tr></thead><tbody>
<tr><td>Round number</td><td>Little endian unsigned integer</td><td>8</td></tr>
<tr><td>Set ID</td><td>Little endian unsigned integer</td><td>8</td></tr>
<tr><td>Target block hash</td><td>Bytes</td><td>32</td></tr>
<tr><td>Target block number</td><td>Little endian unsigned integer</td><td>4 TODO or 8 due to block number</td></tr>
<tr><td>Number of precommits</td><td>SCALE-compact-encoded unsigned integer</td><td>(variable)</td></tr>
<tr><td>(repeated) Precommits</td><td>Vote (see below) repeated <em>Number of precommits</em> times</td><td>36 or 40 times <em>Number of precommits</em> TODO</td></tr>
<tr><td>Number of authentication data</td><td>SCALE-compact-encoded unsigned integer</td><td>(variable)</td></tr>
<tr><td>(repeated) Authentication data</td><td>Authentication data (see below) repeated <em>Number of authentication data</em> times</td><td>96 times <em>Number of authentication data</em></td></tr>
</tbody></table>
<p>Where a <strong>Vote</strong> is defined as:</p>
<table><thead><tr><th>Field name</th><th>Type</th><th>Size (bytes)</th></tr></thead><tbody>
<tr><td>Target block hash</td><td>Bytes</td><td>32</td></tr>
<tr><td>Target block number</td><td>Little endian unsigned integer</td><td>4 TODO or 8 due to block number</td></tr>
</tbody></table>
<p>And <strong>Authentication data</strong> is defined as:</p>
<table><thead><tr><th>Field name</th><th>Type</th><th>Size (bytes)</th></tr></thead><tbody>
<tr><td>Signature</td><td>Bytes</td><td>64</td></tr>
<tr><td>Authority public key</td><td>Bytes</td><td>32</td></tr>
</tbody></table>
<h3 id="grandpa-justification"><a class="header" href="#grandpa-justification">Grandpa justification</a></h3>
<p>A <strong>Grandpa justification</strong> is defined as:</p>
<table><thead><tr><th>Field name</th><th>Type</th><th>Size (bytes)</th></tr></thead><tbody>
<tr><td>Round number</td><td>Little endian unsigned integer</td><td>8</td></tr>
<tr><td>Target block hash</td><td>Bytes</td><td>32</td></tr>
<tr><td>Target block number</td><td>Little endian unsigned integer</td><td>4 TODO or 8 due to block number</td></tr>
<tr><td>Number of precommits</td><td>SCALE-compact-encoded unsigned integer</td><td>(variable)</td></tr>
<tr><td>(repeated) Precommits</td><td>Vote (see below) repeated <em>Number of precommits</em> times</td><td>36 or 40 times <em>Number of precommits</em> TODO</td></tr>
<tr><td>Number of vote ancestries</td><td>SCALE-compact-encoded unsigned integer</td><td>(variable)</td></tr>
<tr><td>(repeated) Vote ancestries</td><td>Block header repeated <em>Number of vote ancestries</em> times</td><td>(variable)</td></tr>
</tbody></table>
<p>Where a <strong>Vote</strong> is defined as:</p>
<table><thead><tr><th>Field name</th><th>Type</th><th>Size (bytes)</th></tr></thead><tbody>
<tr><td>Target block hash</td><td>Bytes</td><td>32</td></tr>
<tr><td>Target block number</td><td>Little endian unsigned integer</td><td>4 TODO or 8 due to block number</td></tr>
<tr><td>Signature</td><td>Bytes</td><td>64</td></tr>
<tr><td>Authority public key</td><td>Bytes</td><td>32</td></tr>
</tbody></table>
<h3 id="verification"><a class="header" href="#verification">Verification</a></h3>
<p>A <em>Grandpa commit</em> or <em>Grandpa justification</em> can be <strong>verified</strong> by following these steps:</p>
<ul>
<li>Fail the verification if there exists an <em>autority public key</em> that isn't present in the <em>Grandpa validators set</em> of the parent of the target block.</li>
<li>Fail the verification if there exists two <em>authority public key</em>s that are equal.</li>
<li>Fail the verification if the number of precommits is strictly inferior to <code>length(Grandpa validators set(parent)) * 2 / 3 + 1</code>. TODO: not satisfied with equation like that</li>
<li>Fail the verification if any of the target block hash and number of any of the votes isn't equal or a descendant of the target block hash and number of the commit or justification.</li>
<li>TODO verify signatures</li>
<li>TODO verify block ancestries</li>
</ul>
<h2 id="finalized-block"><a class="header" href="#finalized-block">Finalized block</a></h2>
<p>Given a <em>tree of blocks</em>, a set of <em>verified Grandpa commit</em>s, and a set of <em>verified Grandpa justification</em>s, the <strong>latest finalized block</strong> is defined as the block with the highest <em>block number</em> TODO explain better</p>
<p>TODO: explain that there must be no gap in the commits and justifications ^ </p>
<p>An implementation can assume that when it adds a new <em>Grandpa commit</em> or <em>Grandpa justification</em> to the set, the <em>latest finalized block</em> can only ever become a descendant of the previous <em>latest finalized block</em>. TODO unclear
If this assumption happened to be violated, the chain can be declared broken. Broken chains are out of scope of this specification. TODO: explain this somewhere this</p>
<blockquote>
<p><strong>Note</strong>: Thanks to this assumption, many of the block characteristics that an implementation typically puts in a cache (such as the Grandpa validators set) only need to be tracked for the latest finalized block and its descendants.</p>
</blockquote>
<p>A block is <strong>finalized</strong> either if it is equal to the <em>latest finalized block</em>, or if it is the parent of a <em>finalized</em> block.</p>
<blockquote>
<p><strong>Note</strong>: In other words, the <em>latest finalized block</em> and all of its ancestors (and no other block besides them) are <em>finalized</em>.</p>
</blockquote>
<h2 id="finalizable-block"><a class="header" href="#finalizable-block">Finalizable block</a></h2>
<p>A <em>block header</em> is <strong>finalizable</strong> if all of the following is true:</p>
<ul>
<li>Its parent block is <em>finalized</em> or <em>finalizable</em>.</li>
<li>If the <em>validators set id</em> of the block is different from the <em>validators set id</em> of its parent block, its parent block must be <em>finalized</em>.</li>
<li>TODO: parachain stuff https://paritytech.github.io/polkadot-sdk/book/protocol-chain-selection.html</li>
</ul>
<h2 id="grandpa-rounds"><a class="header" href="#grandpa-rounds">Grandpa rounds</a></h2>
<p>Given a set of prevote <em>block headers</em>, a set of precommit <em>block headers</em>, and a <em>number of validators</em>:</p>
<h3 id="supermajority-threshold"><a class="header" href="#supermajority-threshold">Supermajority threshold</a></h3>
<p>The <strong>supermajority threshold</strong> is defined as <code>(number of validators - number of validators that have equivocated) * 2 / 3 + 1</code>.</p>
<h3 id="prevotes-ghost"><a class="header" href="#prevotes-ghost">Prevotes ghost</a></h3>
<p>The <strong>prevotes ghost</strong> is defined as the highest block header in the prevotes that has a supermajority of the threshold.
If the number of prevote <em>block headers</em> is too small, the prevotes ghost is undefined.
TODO explain better</p>
<blockquote>
<p><strong>Note</strong>: As more block headers are added, the prevotes ghost can only ever move to higher blocks.</p>
</blockquote>
<h3 id="estimate"><a class="header" href="#estimate">Estimate</a></h3>
<p>The <strong>estimate</strong> is defined as the precommit block header inferior or equal to the <em>prevotes ghost</em> that can potentially achieve a supermajority of the threshold.
TODO: define more formally</p>
<blockquote>
<p><strong>Note</strong>: More informally, the estimate is the highest block that could still potentially achieve a supermajority.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong>: As more precommit block headers are added to the set, the estimate can only ever move to lower blocks. As more prevote block headers are added to the set, the estimate can only ever move to higher blocks.</p>
</blockquote>
<h3 id="completable"><a class="header" href="#completable">Completable</a></h3>
<p>A round is <strong>completable</strong> if either:</p>
<ul>
<li>The <em>estimate</em> is strictly inferior to the <em>prevotes ghost</em>.</li>
<li>It becomes impossible for the <em>estimate</em> to become strictly superior to the <em>prevotes ghost</em>.</li>
</ul>
<p>A <em>completable</em> round can be turned into a <em>Grandpa commit</em> or a <em>Grandpa justification</em> whose <em>target block hash</em> and <em>target block number</em> is the <em>estimate</em> of the round.</p>
<blockquote>
<p><strong>Note</strong>: In other words, once a round is completable, its estimate can be finalized, assuming that .</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="blocks-authoring.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="transactions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="blocks-authoring.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="transactions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
