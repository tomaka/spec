<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>State</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="state.html"><strong aria-hidden="true">1.</strong> State</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="runtime.html"><strong aria-hidden="true">1.1.</strong> WebAssembly runtime</a></li></ol></li><li class="chapter-item expanded "><a href="blocks.html"><strong aria-hidden="true">2.</strong> Blocks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="blocks-verification.html"><strong aria-hidden="true">2.1.</strong> Blocks verification</a></li><li class="chapter-item expanded "><a href="blocks-authoring.html"><strong aria-hidden="true">2.2.</strong> Blocks authoring</a></li><li class="chapter-item expanded "><a href="blocks-finalization.html"><strong aria-hidden="true">2.3.</strong> Blocks finalization</a></li></ol></li><li class="chapter-item expanded "><a href="transactions.html"><strong aria-hidden="true">3.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="parachains.html"><strong aria-hidden="true">4.</strong> Parachains</a></li><li class="chapter-item expanded "><a href="network.html"><strong aria-hidden="true">5.</strong> Networking</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="network-transport.html"><strong aria-hidden="true">5.1.</strong> Transport</a></li><li class="chapter-item expanded "><a href="network-matrix.html"><strong aria-hidden="true">5.2.</strong> Validators matrix</a></li><li class="chapter-item expanded "><a href="network-protocol.html"><strong aria-hidden="true">5.3.</strong> Protocols</a></li><li class="chapter-item expanded "><a href="network-kad.html"><strong aria-hidden="true">5.4.</strong> Kademlia</a></li></ol></li><li class="chapter-item expanded "><a href="session-keys.html"><strong aria-hidden="true">6.</strong> Session keys</a></li><li class="chapter-item expanded "><a href="requirements.html"><strong aria-hidden="true">7.</strong> Requirements</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="state"><a class="header" href="#state">State</a></h1>
<h2 id="trie"><a class="header" href="#trie">Trie</a></h2>
<p>A <strong>trie</strong> is defined as:</p>
<ul>
<li>A <em>hash algorithm</em></li>
<li>A (potentially empty) tree of nodes.</li>
</ul>
<p>Each <strong>node</strong> is defined as:</p>
<ul>
<li>A <em>partial key</em> made of 4 bits <strong>nibbles</strong>.</li>
<li>Between zero and sixteen children nodes.</li>
<li>Optionally, a <strong>storage value</strong> and a <strong>storage value version</strong> (either both present or both absent). The storage value version is equal to either <code>0</code> or <code>1</code>.</li>
</ul>
<p>Nodes with exactly one child and no storage value are invalid.</p>
<p>Any given <em>trie</em> is either empty, or has one <em>node</em> with no parent and a set of nodes whose parent is also in the trie. Cycles are forbidden.</p>
<p>The <strong>key</strong> of a node is defined as the concatenation of the key of the parent, the index of the node within its parent's children list, and the partial key of the node.</p>
<p>The <strong>Merkle value</strong> of a trie is defined as:</p>
<ul>
<li>If the trie is not empty, it is equal to the hash of the <em>trie node value</em> of the trie node that serves as the common ancestor of all other trie nodes.</li>
<li>If the trie is empty, it is equal to the hash of a trie node value whose <em>Header</em> is equal to <code>0</code>.</li>
</ul>
<blockquote>
<p><strong>Note</strong>: The Merkle value of a BLAKE2 empty trie is always equal to <code>0x03170a2e7597b7b7e3d84c05391d139a62b157e78786d8c082f29dcf4c111314</code>. The Merkle value of a Keccak256 empty trie is <code>0xbc36789e7a1e281436464229828f817d6612f7b477d66591ff96a9e064bcc98a</code>.</p>
</blockquote>
<h2 id="state-1"><a class="header" href="#state-1">State</a></h2>
<p>The <strong>state</strong> is composed of:</p>
<ul>
<li>One main <em>trie</em> whose hash algorithm is <a href="https://datatracker.ietf.org/doc/html/rfc7693">BLAKE2</a>.</li>
<li>Zero or more child <em>trie</em>s whose hash algorithm is <a href="https://datatracker.ietf.org/doc/html/rfc7693">BLAKE2</a>.</li>
</ul>
<p>TODO: talk about the Merkle value of child tries within the main trie</p>
<h2 id="trie-node-value-and-merkle-value"><a class="header" href="#trie-node-value-and-merkle-value">Trie node value and Merkle value</a></h2>
<h3 id="trie-node-value"><a class="header" href="#trie-node-value">Trie node value</a></h3>
<p>A <strong>trie node value</strong> is defined as:</p>
<table><thead><tr><th>Field name</th><th>Type</th><th>Size (bytes)</th></tr></thead><tbody>
<tr><td>Header</td><td>(see below)</td><td>1</td></tr>
<tr><td>Partial key extra length</td><td>(see below)</td><td>(variable)</td></tr>
<tr><td>Partial key</td><td>(see below)</td><td>(variable)</td></tr>
<tr><td>Children bitmap</td><td>(optional) Little endian unsigned integer</td><td>0 or 2</td></tr>
<tr><td>Storage value</td><td>(see below)</td><td>(variable)</td></tr>
<tr><td>Children</td><td>(see below) repeated 16 times</td><td>(variable)</td></tr>
</tbody></table>
<p>Where:</p>
<p><em>Header</em> is one byte that is used to determine the format of the rest of the trie node value.
If the 4 most significant bits of <em>Header</em> are equal to <code>0000</code>, then the value of all the bits of <em>Header</em> must be equal to <code>0</code>.</p>
<p>The <em>Partial key length in header</em> is defined as:</p>
<ul>
<li>If the two most significant bits of <em>Header</em> are equal to <code>01</code>, <code>10</code>, or <code>11</code>, it is equal to the 6 least significant bits of <em>Header</em>.</li>
<li>If the three most significant bits of <em>Header</em> are equal to <code>001</code>, it is equal to the 5 least significant bits of <em>Header</em>.</li>
<li>If the four most significant bits of <em>Header</em> are equal to <code>0001</code>, it is equal to the 4 least significant bits of <em>Header</em>.</li>
<li>If the <em>Header</em> is equal to <code>0</code>, is it equal to <code>0</code>.</li>
</ul>
<p>The <em>Partial key extra length</em> is defined as:</p>
<ul>
<li>If the <em>Partial key length in header</em> is equal to <code>63</code>, it is a serie of zero or more bytes equal to <code>255</code> followed with one byte that is not equal to <code>255</code>.</li>
<li>If the <em>Partial key length in header</em> is not equal to <code>63</code>, it is empty (the field is not present).</li>
</ul>
<p>The <em>Partial key length</em> is defined as the sum of the value of each byte of <em>Partial key extra length</em>, plus the value of <em>Partial key length in header</em>.</p>
<p>The <em>Partial key</em> is defined as:</p>
<ul>
<li>If <em>Partial key length</em> is an even number, a list of bytes whose length is <em>Partial key length</em> divided by 2.</li>
<li>If <em>Partial key length</em> is an uneven number, a list of bytes whose length is (1 plus <em>Partial key length</em>) divided by 2. The four most significant bits of the first byte must be equal to <code>0000</code>.
TODO: convert to nibbles</li>
</ul>
<p><em>Children bitmap</em> is present only if the most significant bit of <em>Header</em> is <code>1</code>, or if the four most significant bits of <em>Header</em> are <code>0001</code>. If <em>Children bitmap</em> is missing, it implicitly has a value of <code>0</code>.</p>
<p><em>Storage value</em> is present only if the second most significant bit of <em>Header</em> is <code>1</code>, if the three most significant bits of <em>Header</em> are <code>001</code>, or if the four most significant bits of <em>Header</em> are <code>0001</code>.</p>
<p>The <em>Storage value version</em> is defined as:</p>
<ul>
<li><code>0</code> if the second most significant bit of <em>Header</em> is <code>1</code>.</li>
<li><code>1</code> if the three most significant bits of <em>Header</em> are <code>001</code>, or if the four most significant bits of <em>Header</em> are <code>0001</code>.</li>
<li>Undefined otherwise.</li>
</ul>
<p>If the <em>Storage value version</em> is <code>0</code>, then the <em>Storage value</em> field is defined as:</p>
<table><thead><tr><th>Field name</th><th>Type</th><th>Size (bytes)</th></tr></thead><tbody>
<tr><td>Storage value size</td><td>SCALE-compact-encoded unsigned integer</td><td>(variable)</td></tr>
<tr><td>Storage value</td><td>Bytes</td><td><em>Storage value size</em></td></tr>
</tbody></table>
<p>If the <em>Storage value version</em> is <code>1</code>, then the <em>Storage value</em> field is defined as:</p>
<table><thead><tr><th>Field name</th><th>Type</th><th>Size (bytes)</th></tr></thead><tbody>
<tr><td>Storage value</td><td>Bytes</td><td>32</td></tr>
</tbody></table>
<p>Each of the 16 elements of <em>Children</em> corresponds to a bit in <em>Children bitmap</em>. The first child corresponds to the least significant bit, the second child corresponds to the second least significant bit, and so on. The last child corresponds to the most significant bit.</p>
<p>For each element of <em>Children</em>, if the corresponding bit in <em>Children bitmap</em> is <code>0</code>, then it is empty. Otherwise, it is defined as:</p>
<table><thead><tr><th>Field name</th><th>Type</th><th>Size (bytes)</th></tr></thead><tbody>
<tr><td>Child Merkle value size</td><td>SCALE-compact-encoded unsigned integer</td><td>(variable)</td></tr>
<tr><td>Child Merkle value</td><td>Bytes</td><td><em>Child Merkle value size</em></td></tr>
</tbody></table>
<p><em>Child Merkle value size</em> is always inferior or equal to 32.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->

                            <a rel="next" href="runtime.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

                    <a rel="next" href="runtime.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
